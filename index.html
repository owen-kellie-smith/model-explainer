<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Model-Visualisation-Demo 1.0.20</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    #left, #right {
      height: 100%;
    }
    #left {
      width: 40%;
      padding: 1em;
      overflow: hidden;
      box-sizing: border-box;
    }
    #right {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: #f9f9f9;
    }
    #splitter {
      width: 5px;
      cursor: ew-resize;
      background: #ccc;
    }
    textarea {
      width: 100%;
      height: 100%;
      border: none;
      resize: none;
      font-family: monospace;
      font-size: 1.1em;
      outline: none;
      overflow-y: auto;
      box-sizing: border-box;
    }
    #toolbar {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5em;
      padding: 0.6em 0.8em;
      border-bottom: 1px solid #ddd;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    #toolbar span {
      font-size: 0.95em;
    }
    #status {
      margin-left: auto;
      color: #666;
      font-size: 0.9em;
    }
    #preview {
      flex: 1 1 auto;
      width: 100%;
      text-align: center;
      overflow: auto;
      padding: 1em;
      box-sizing: border-box;
    }
    #preview svg {
      max-width: 100%;
      max-height: 100%;
    }
    #downloadLinks {
      flex: 0 0 auto;
      text-align: center;
      padding: 0.8em;
      border-top: 1px solid #ddd;
      background: #fff;
      position: sticky;
      bottom: 0;
    }
    #error {
      color: #b00020;
      white-space: pre-wrap;
      text-align: left;
      margin: 1em auto;
      max-width: 920px;
      background: #fff0f0;
      border: 1px solid #f3c5c5;
      padding: 0.75em;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="left">
    <textarea id="umlInput" spellcheck="false" placeholder="Paste or type a diagram hereâ€¦"></textarea>
  </div>

  <div id="splitter"></div>

  <div id="right">
    <div id="toolbar" title="Supported languages: Mermaid, PlantUML, Graphviz (DOT).
      To force detection:
      â€¢ Mermaid: start with any of graph|flowchart|sequenceDiagram|classDiagram|...'
      â€¢ PlantUML: include '@startuml|enduml'
      â€¢ Graphviz: start with 'digraph {'">    
      <span>Language: <strong id="detectedLabel">Mermaid</strong> 
      (<a id="languageLink" href="#" target="_blank" style="text-decoration:none;color:#0078d4;">Learn more</a>)
      </span>
      <span>
        <a href="#" id="loadExample"
         style="text-decoration:none;color:#0078d4;">
         Example
        </a>
      </span>
      <span id="status">Ready</span>
    </div>

    <div id="preview"><em>Diagram will appear here</em></div>

    <div id="downloadLinks">
      <a id="downloadPNG" href="#" download="diagram.png">Download as PNG</a> |
      <a id="downloadSVG" href="#" download="diagram.svg">Download as SVG</a>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/zlibjs@0.3.1/bin/zlib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/viz.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/viz.js@2.1.2/full.render.js"></script>

  <script>

// High-level flow:
// startup â†’ derive state â†’ render
// events â†’ update state â†’ render

/* =========================================================
   1. Globals & Application State
   What exists and what the app believes is true
   ========================================================= */

    const el_g_umlInput = document.getElementById('umlInput');
    const el_g_preview = document.getElementById('preview');
    const el_g_detectedLabel = document.getElementById('detectedLabel');
    const el_g_languageLink = document.getElementById('languageLink');
    const el_g_downloadPNG = document.getElementById('downloadPNG');
    const el_g_downloadSVG = document.getElementById('downloadSVG');
    const el_g_splitter = document.getElementById('splitter');
    const el_g_left = document.getElementById('left');
    const el_g_loadExample = document.getElementById('loadExample');
    const el_g_status = document.getElementById('status');

    let viz = new Viz();
    let timeout;
    let plantUmlImg = null;
    let lastRenderedLanguage = null;
    let currentExampleIndex = -1;
    let isInitializing = true;
    let isDragging = false;

    const DiagramState = { text:'', language:'mermaid', title:'Diagram' };
    mermaid.initialize({ startOnLoad: false }); // window.mermaid is attached by mermaid.min.js called earlier


    const EXAMPLES = [
      {
        name: 'PlantUML â€“ Development Cycle',
        text: `
      @startuml
          title Development cycle

          actor User
          actor Developer
          component Code
          User --> Developer
          Developer --> Code
      @enduml`
      },
      {
        name: 'Mermaid â€“ Flowchart',
        text: `
     flowchart LR
        A[Start] --> B{Decision}
        B -->|Yes| C[Continue]
        B -->|No| D[Stop]`
      },
      {
        name: 'Graphviz â€“ Simple Graph',
        text: `
       digraph Demo {
            A -> B
            B -> C
            C -> A
    }`
      }
    ];


/* =========================================================
   2. Startup & Initial State Resolution
   One-time boot logic (URL â†’ text â†’ state â†’ first render)
   ========================================================= */

    window.addEventListener('load', async () => {
      setStatus('Initializingâ€¦', 'busy');
      initState();
      Object.assign(DiagramState, deriveState(DiagramState.text));
      isInitializing = false;    // NOW URL updates allowed
      await renderFromState();   // render only
    });


/* =========================================================
   3. Event Handlers (User & Browser Actions)
   Things that trigger behavior but do not do the work
   ========================================================= */

    el_g_umlInput.addEventListener('input', () => {
      clearTimeout(timeout);
      setStatus('Waiting for inputâ€¦', 'busy');
      timeout = setTimeout(() => {
        updateState(el_g_umlInput.value);
      }, 600);
    });


el_g_loadExample.addEventListener('click', (e) => {
  e.preventDefault();

  currentExampleIndex =
    (currentExampleIndex + 1) % EXAMPLES.length;

  const example = EXAMPLES[currentExampleIndex];

  el_g_umlInput.value = example.text;
  updateState(example.text);

  setStatus(`Loaded example: ${example.name}`);
});

    el_g_splitter.addEventListener('mousedown', () => {
      isDragging = true;
      document.body.style.cursor = 'ew-resize';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const screenWidth = window.innerWidth;
      const rawPercent = Math.max(20,Math.min(80,(e.clientX / screenWidth) * 100));
      el_g_left.style.width = `${Math.round(rawPercent / 5) * 5}%`;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      document.body.style.cursor = 'default';
    });

/* =========================================================
   4. Behavior Functions (What the app actually does when called by event listeners)
   State updates, URl-encoding, detection, helpers
   ========================================================= */
   
/* =========================================================
   4.1 Functions â€” diagram state & orchestration
   ========================================================= */

    function setStatus(text, kind = 'neutral') {
      el_g_status.textContent = text;

      el_g_status.style.color =
        kind === 'error' ? '#b00020' :
        kind === 'busy'  ? '#555' :
                           '#666';
    }

    function initState() {
      const fromUrl = getDiagramFromUrl();

      if (fromUrl) {
        DiagramState.text = fromUrl.text;
        DiagramState.language = fromUrl.language;
      } else {
        DiagramState.text = el_g_umlInput.value;
      }
      el_g_umlInput.value = DiagramState.text;
    }

    function deriveState(text) {
      const language = detectLanguage(text);
      let title = 'Diagram';
      if (language === 'mermaid') title = 'Mermaid Diagram';
      else if (language === 'plantuml') title = 'PlantUML Diagram';
      else title = extractGraphTitle(text);
      return { text, language, title };
    }

    async function updateState(text, opts = {}) {
      // opts.lockLanguage reserved for future manual language override
      const derived = deriveState(text);

      DiagramState.text = text;
      DiagramState.language = opts.lockLanguage
        ? DiagramState.language
        : derived.language;
      DiagramState.title = derived.title;

      updateUrlFromState();
      await renderFromState();
    }

    async function renderFromState() {
      if (!DiagramState.text) {
        el_g_preview.innerHTML = '<em>Choose an example or start typingâ€¦</em>';
        setStatus('Ready');
        return;
      }
      
      // clear initial placeholder
      if (!lastRenderedLanguage) {
        el_g_preview.innerHTML = '';
      }

      setStatus('Renderingâ€¦', 'busy');
      const { text, language, title } = DiagramState;
      document.title = title;
      el_g_detectedLabel.textContent = language;
      if (el_g_languageLink) {
        el_g_languageLink.href =
          language === 'mermaid'
            ? 'https://mermaid.js.org/syntax/examples.html'
            : language === 'plantuml'
            ? 'https://plantuml.com'
            : 'https://graphviz.org/gallery/';
      }
      // Clear preview when switching renderer types
      if (lastRenderedLanguage && lastRenderedLanguage !== language) {
        el_g_preview.innerHTML = '';
        plantUmlImg = null;
      }

      try {
        if (language === 'mermaid') {
          const d = document.createElement('div');
          d.className = 'mermaid';
          d.textContent = text;
          el_g_preview.appendChild(d);

          mermaid.init(undefined, d);

          // ðŸ‘‡ WAIT for Mermaid to finish rendering
          requestAnimationFrame(() => {
            const svg = d.querySelector('svg');
            if (svg) {
              enableSvgAndPngDownloads(svg, title);
              markAsRendered(language);

            }
          });
        } else if (language === 'graphviz') {
          let svg;
          try {
            svg = await viz.renderSVGElement(text);
          } catch (e) {
            viz = new Viz(); // reset after failure
            throw e;
          }
          el_g_preview.appendChild(svg);
          enableSvgAndPngDownloads(svg, title);
          markAsRendered(language);

        } else {
          const encoded = encodePlantUml(text);
          const svgUrl = `https://www.plantuml.com/plantuml/svg/~1${encoded}`;
          const pngUrl = `https://www.plantuml.com/plantuml/png/~1${encoded}`;

          // Reuse a single <img> to avoid aborting in-flight requests (Firefox)
          if (!plantUmlImg) {
            plantUmlImg = document.createElement('img');
            el_g_preview.appendChild(plantUmlImg);
          }

          // Clear previous handlers to avoid stacking
          plantUmlImg.onload = null;
          plantUmlImg.onerror = null;

          plantUmlImg.onload = () => {
            markAsRendered( 'plantuml');
          };

          plantUmlImg.onerror = () => {
            setStatus('Error loading PlantUML diagram', 'error');
          };

          plantUmlImg.src = pngUrl;

          el_g_downloadSVG.href = svgUrl;
          el_g_downloadSVG.download = `${title}.svg`;
          el_g_downloadPNG.href = pngUrl;
          el_g_downloadPNG.download = `${title}.png`;


        }
      } catch(e) {
        el_g_preview.innerHTML='<div id="error">'+e.message+'</div>';
        el_g_downloadSVG.removeAttribute('href');
        el_g_downloadPNG.removeAttribute('href');
        setStatus('Error', 'error');
      }
    }


    function markAsRendered( sLanguage){
              lastRenderedLanguage = sLanguage;
              setStatus('Rendered');
              setTimeout(() => {
                setStatus('Ready');
              }, 800);
    }

/* =========================================================
   4.2 Functions â€” URL encoding / decoding
   ========================================================= */

    function getDiagramFromUrl() {
      const p = new URLSearchParams(location.search);
      const enc = p.get('diagram');
      if (!enc) return null;
      const lang = p.get('lang') || 'plantuml';
      try { return { text: decodeDiagramFromUrl(enc, lang), language: lang }; }
      catch { return null; }
    }

    function updateUrlFromState() {
      if (isInitializing) return;
      if (!DiagramState.text) return;

      const p = new URLSearchParams();
      p.set('lang', DiagramState.language);
      p.set('diagram', encodeDiagramForUrl(
        DiagramState.text,
        DiagramState.language
      ));
      history.replaceState(null, '', location.pathname + '?' + p.toString());
    }

    function encodeDiagramForUrl(text, lang) {
      return lang === 'plantuml' ? encodePlantUml(text) : encodeB64(text);
    }

    function decodeDiagramFromUrl(enc, lang) {
      return lang === 'plantuml' ? decodePlantUml(enc) : decodeB64(enc);
    }

    function decodeB64(t){
      return decodeURIComponent(escape(atob(t)));
    }

    function encodeB64(t){
      return btoa(unescape(encodeURIComponent(t)));
    }
  
    function decodePlantUml(enc) {
      const data = plantumlDecode(enc);
      const inflater = new Zlib.Inflate(data);
      const decompressed = inflater.decompress();
      return new TextDecoder().decode(decompressed);
    }

    function plantumlDecode(s) {
      const alphabet = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
      const bytes = [];

      for (let i = 0; i < s.length; i += 4) {
        const c1 = alphabet.indexOf(s.charAt(i));
        const c2 = alphabet.indexOf(s.charAt(i + 1));
        const c3 = alphabet.indexOf(s.charAt(i + 2));
        const c4 = alphabet.indexOf(s.charAt(i + 3));

        const b1 = (c1 << 2) | (c2 >> 4);
        const b2 = ((c2 & 0xf) << 4) | (c3 >> 2);
        const b3 = ((c3 & 0x3) << 6) | c4;

        bytes.push(b1);
        if (c3 !== 64) bytes.push(b2);
        if (c4 !== 64) bytes.push(b3);
      }

      return new Uint8Array(bytes);
    }


/* =========================================================
   4.3 Functions â€” language detection & metadata
   ========================================================= */

    function detectLanguage(text) {
      const t = text.trim();
      if (/@startuml\b/i.test(t)) return 'plantuml';
      if (/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram|erDiagram|journey|gantt|pie|mindmap|timeline)\b/i.test(t)) return 'mermaid';
      if (/^(digraph|graph)\b[\s\S]*\{/i.test(t)) return 'graphviz';
      return 'mermaid';
    }

    function extractGraphTitle(text) {
      // Match digraph or graph followed by quoted or unquoted name
      const nameMatch = text.match(/(?:digraph|graph)\s+(?:"([^"]+)"|([^\s{]+))/i);
      if (nameMatch) {
        return nameMatch[1] || nameMatch[2]; // quoted OR unquoted
      }

      // Fallback: first label
      const labelMatch = text.match(/label\s*=\s*"([^"]+)"/i);
      return labelMatch ? labelMatch[1] : 'Graphviz Diagram';
    }


/* =========================================================
   4.4 Functions â€” encoding & export utilities
   ========================================================= */

    function encodePlantUml(text) {
      const deflate = new Zlib.Deflate(new TextEncoder().encode(text));
      const compressed = deflate.compress();
      return plantumlEncode(compressed);
    }

    function plantumlEncode(dataBytes) {
    // see e.g. https://plantuml.com/code-javascript-synchronous
      const alphabet = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
      let result = "";
      for (let i = 0; i < dataBytes.length;) {
        const b1 = dataBytes[i++], b2 = i < dataBytes.length ? dataBytes[i++] : 0, b3 = i < dataBytes.length ? dataBytes[i++] : 0;
        const c1 = b1 >> 2;
        const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
        const c3 = ((b2 & 0xf) << 2) | (b3 >> 6);
        const c4 = b3 & 0x3f;
        result += alphabet[c1] + alphabet[c2] + alphabet[c3] + alphabet[c4];
      }
      return result;
    }

    function enableSvgAndPngDownloads(svgElement, title) {
      // ---- SVG ----
      const svgData = new XMLSerializer().serializeToString(svgElement);
      const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
      const svgUrl = URL.createObjectURL(svgBlob);

      el_g_downloadSVG.href = svgUrl;
      el_g_downloadSVG.download = `${title}.svg`;

      // ---- PNG ----
      const img = new Image();
      img.src = 'data:image/svg+xml;base64,' +
                btoa(unescape(encodeURIComponent(svgData)));

      img.onload = () => {
        const vb = svgElement.viewBox?.baseVal;
        const w = vb?.width || img.width;
        const h = vb?.height || img.height;

        const canvas = document.createElement('canvas');
        canvas.width = w * 2;
        canvas.height = h * 2;

        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        el_g_downloadPNG.href = canvas.toDataURL('image/png');
        el_g_downloadPNG.download = `${title}.png`;
      };
    }


  </script>
<!--
====================================================================
MODEL-VISUALISATION-DEMO â€” MANUAL FUNCTIONAL CHECKLIST
====================================================================

Use this checklist for manual QA / regression testing.
Tick mentally (or copy elsewhere) after changes.

--------------------------------------------------------------------
0. PAGE LOAD & BASELINE
--------------------------------------------------------------------
[ ] Page loads without console errors
[ ] No fatal JS exceptions on startup
[ ] Body fills viewport, no body scrollbars
[ ] Title is set and later updates dynamically

--------------------------------------------------------------------
1. LAYOUT & UI STRUCTURE
--------------------------------------------------------------------
[ ] Left pane contains textarea
[ ] Right pane contains toolbar, preview, downloads
[ ] Initial split ~40% / 60%
[ ] Panes scroll internally, not the body

Splitter
[ ] Splitter visible between panes
[ ] Cursor changes to resize cursor
[ ] Mouse down starts drag
[ ] Drag resizes panes horizontally
[ ] Left pane constrained to ~20â€“80%
[ ] Width snaps to 5% increments
[ ] Mouse up ends drag and restores cursor

--------------------------------------------------------------------
2. TEXT INPUT
--------------------------------------------------------------------
[ ] Default embedded diagram appears on first load
[ ] Textarea is monospace
[ ] Spellcheck disabled
[ ] Textarea fills left pane height
[ ] Vertical scrolling works
[ ] Textarea does not show resize handle

--------------------------------------------------------------------
3. LIVE UPDATE BEHAVIOR
--------------------------------------------------------------------
[ ] Editing text triggers re-render
[ ] Rendering is debounced (~600ms)
[ ] Continuous typing does not thrash renderer
[ ] Minor edits (add/remove space) re-render correctly
[ ] Empty input does not crash app

--------------------------------------------------------------------
4. LANGUAGE DETECTION
--------------------------------------------------------------------
Automatic detection
[ ] @startuml â†’ PlantUML
[ ] Mermaid keywords â†’ Mermaid
[ ] digraph { â†’ Graphviz
[ ] Unknown input defaults to Mermaid

Feedback
[ ] Detected language shown in toolbar
[ ] Label updates when input changes
[ ] Renderer matches detected language

--------------------------------------------------------------------
5. TOOLBAR
--------------------------------------------------------------------
[ ] Toolbar stays visible while preview scrolls
[ ] Language label updates correctly
[ ] "Learn more" link updates per language
[ ] Learn-more opens in new tab
[ ] Status element present

--------------------------------------------------------------------
6. DIAGRAM RENDERING
--------------------------------------------------------------------
Mermaid
[ ] Diagram renders correctly
[ ] Errors shown in error box
[ ] SVG appears in DOM
[ ] Re-render replaces old output cleanly

Graphviz
[ ] DOT renders via Viz.js
[ ] Errors handled gracefully
[ ] Preview clears before re-render

PlantUML
[ ] Diagram rendered via remote server
[ ] SVG loads correctly
[ ] Network or syntax errors handled

--------------------------------------------------------------------
7. ERROR HANDLING
--------------------------------------------------------------------
[ ] Syntax errors produce visible error box
[ ] Error text preserves line breaks
[ ] Errors do not break subsequent renders
[ ] Download links cleared on error

--------------------------------------------------------------------
8. DOWNLOADS â€” SVG
--------------------------------------------------------------------
Mermaid
[ ] SVG download enabled after render
[ ] SVG file is non-empty
[ ] SVG opens correctly
[ ] Filename matches diagram title

Graphviz
[ ] SVG download works
[ ] Content matches preview

PlantUML
[ ] SVG download uses PlantUML server
[ ] Filename correct

--------------------------------------------------------------------
9. DOWNLOADS â€” PNG
--------------------------------------------------------------------
Mermaid
[ ] PNG download enabled after render
[ ] PNG not blank
[ ] White background
[ ] Scaled resolution (2Ã—)
[ ] Content matches SVG

Graphviz
[ ] PNG export works
[ ] PNG not blank

PlantUML
[ ] PNG download via PlantUML server

--------------------------------------------------------------------
10. URL ENCODING / SHARING
--------------------------------------------------------------------
[ ] URL updates on diagram change
[ ] URL contains lang parameter
[ ] URL contains diagram parameter
[ ] Reload restores diagram from URL
[ ] URL overrides embedded textarea content
[ ] URL not updated during initial load
[ ] Invalid URL fails gracefully

--------------------------------------------------------------------
11. TITLE & METADATA
--------------------------------------------------------------------
[ ] Document title updates on render
[ ] Mermaid â†’ "Mermaid Diagram"
[ ] PlantUML â†’ "PlantUML Diagram"
[ ] Graphviz â†’ graph name or fallback

--------------------------------------------------------------------
12. STABILITY & REGRESSION
--------------------------------------------------------------------
[ ] No memory leaks on repeated renders
[ ] Splitter still works after many renders
[ ] Downloads still work after language switches
[ ] App remains usable after error recovery

====================================================================
END CHECKLIST
====================================================================
-->
</body>
</html>
